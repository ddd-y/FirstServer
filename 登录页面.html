
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/index.css">
    <title>登录页面</title>
    
</head>
<body>
    <!-- 装饰元素 - 增强页面视觉吸引力 -->
    <div class="anime-decoration decoration-1"></div>
    <div class="anime-decoration decoration-2"></div>
    <div class="anime-decoration decoration-3"></div>
    
    <!-- 主容器 -->
    <div class="box">
        <!-- 左侧区域 - 视觉展示 -->
        <div class="left"></div>
        
        <!-- 右侧区域 - 登录注册表单 -->
        <div class="right">
            <!-- 登录表单 -->
            <div id="login-container">
                <h4>登录</h4>
                <form id="login-form">
                    <input class="acc" type="text" placeholder="用户名" id="login-username" required>                
                    <input class="acc" type="password" placeholder="密码" id="login-password" required>
                    <input class="sub" type="submit" value="登录">
                </form>
                <div class="fn">
                    <a id="switch-to-register">注册账号</a>
                    <!-- <a href="javascript:;">找回密码</a> -->
                </div>
            </div>
            
            <!-- 注册表单 -->
            <div id="register-container" style="display: none;">
                <h4>注册</h4>
                <form id="register-form">
                    <input class="acc" type="text" placeholder="用户名" id="register-name" required>                
                    <input class="acc" type="email" placeholder="邮箱" id="register-email" required>
                    <input class="acc" type="password" placeholder="密码" id="register-password" required>
                    <input class="sub" type="submit" value="注册">
                </form>
                <div class="fn">
                    <a id="switch-to-login">返回登录</a>
                </div>
            </div>
            
            <!-- 消息提示区域 -->
            <div id="message-area"></div>
        </div>
    </div>

    <script>
        // ===== 全局变量和配置 =====
        const BASE_URL = 'http://192.168.78.129:8081'; // 替换为实际地址
        
        // 用户认证令牌存储
        let authToken = '';
        
        // ===== DOM元素获取 =====
        const loginContainer = document.getElementById('login-container');
        const registerContainer = document.getElementById('register-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const switchToRegister = document.getElementById('switch-to-register');
        const switchToLogin = document.getElementById('switch-to-login');
        const messageArea = document.getElementById('message-area');
        
        // ===== 工具函数 =====
        function showMessage(message, type = 'info') {
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
        }
        
        function clearMessage() {
            messageArea.innerHTML = '';
        }
        
        function switchToLoginForm() {
            registerContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            clearMessage();
        }
        
        function switchToRegisterForm() {
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'block';
            clearMessage();
        }
        
        // ===== API调用函数 =====
        async function checkServerHealth() {
            try {
                const response = await fetch(`${BASE_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'healthy';
                }
                return false;
            } catch (error) {
                console.error('服务器健康检查失败:', error);
                return false;
            }
        }
        
        // 注册API - 更新为匹配C++ API
        async function registerUser(name, email, password) {
            try {
                const response = await fetch(`${BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    // 尝试解析错误响应
                    try {
                        const errorData = await response.json();
                        return {
                            success: false,
                            message: errorData.error || '注册失败'
                        };
                    } catch {
                        return {
                            success: false,
                            message: `注册失败: ${response.status} ${response.statusText}`
                        };
                    }
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('注册请求失败:', error);
                return {
                    success: false,
                    message: '网络错误，请检查服务器连接'
                };
            }
        }
        
        // 登录API - 更新为匹配C++ API（现在返回ip字段）
        async function loginUser(username, password) {
            try {
                const response = await fetch(`${BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });
                
                if (!response.ok) {
                    // 尝试解析错误响应
                    try {
                        const errorData = await response.json();
                        return {
                            success: false,
                            message: errorData.error || '登录失败'
                        };
                    } catch {
                        return {
                            success: false,
                            message: `登录失败: ${response.status} ${response.statusText}`
                        };
                    }
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('登录请求失败:', error);
                return {
                    success: false,
                    message: '网络错误，请检查服务器连接'
                };
            }
        }
        
        // ===== 事件监听器设置 =====
        switchToRegister.addEventListener('click', switchToRegisterForm);
        switchToLogin.addEventListener('click', switchToLoginForm);
        
        // 登录表单提交事件
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            if (!username || !password) {
                showMessage('请输入用户名和密码', 'error');
                return;
            }
            
            showMessage('正在登录，请稍候...', 'info');
            
            // 检查服务器连接
            if (BASE_URL) {
                const isHealthy = await checkServerHealth();
                if (!isHealthy) {
                    showMessage('服务器连接失败，请检查服务器状态', 'error');
                    return;
                }
            }
            
            // 调用登录API
            const result = await loginUser(username, password);
            
            if (result.success) {
                // 登录成功
                authToken = result.token;
                
                showMessage(`登录成功！欢迎 ${result.username}`, 'success');
                
                // 保存到localStorage
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('username', result.username);
                localStorage.setItem('user_id', result.user_id || result.username);
                
                // 保存服务器IP（如果返回）
                if (result.ip) {
                    localStorage.setItem('server_ip', result.ip);
                    console.log('服务器IP地址:', result.ip);
                }
                
                // 跳转到矩阵计算器主页面
                setTimeout(() => {
                    window.location.href = '矩阵计算器.html';
                }, 1500);
            } else {
                // 登录失败
                showMessage(result.message || result.error_message || '登录失败，请检查用户名和密码', 'error');
            }
        });
        
        // 注册表单提交事件
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                showMessage('请输入用户名、邮箱和密码', 'error');
                return;
            }
            
            // 简单邮箱验证
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('请输入有效的邮箱地址', 'error');
                return;
            }
            
            showMessage('正在注册，请稍候...', 'info');
            
            // 检查服务器连接
            if (BASE_URL) {
                const isHealthy = await checkServerHealth();
                if (!isHealthy) {
                    showMessage('服务器连接失败，请检查服务器状态', 'error');
                    return;
                }
            }
            
            // 调用注册API
            const result = await registerUser(name, email, password);
            
            if (result.success) {
                // 注册成功
                showMessage(`注册成功！欢迎 ${name}`, 'success');
                
                // 自动切换到登录表单
                setTimeout(switchToLoginForm, 1500);
            } else {
                // 注册失败
                showMessage(result.message || result.error_message || '注册失败，请稍后重试', 'error');
            }
        });
        
        // ===== 页面加载初始化 =====
        document.addEventListener('DOMContentLoaded', function() {
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                showMessage('检测到已有登录状态，正在跳转...', 'info');
                setTimeout(() => {
                    window.location.href = './矩阵计算器.html';
                }, 1000);
            }
        });
    </script>
</body>
</html>
